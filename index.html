<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPSYSTEM Production ERP</title>
    <meta name="description" content="Система управления производством пленочных материалов">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🏭%3C/text%3E%3C/svg%3E">
    <style>
        /* CSS Variables for theming */
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-bg);
            color: var(--gray-800);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .storage-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .storage-status.connected {
            background: #dcfce7;
            color: #16a34a;
        }

        /* Navigation */
        .nav-container {
            background: var(--white);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .nav-tabs {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            padding: 0 2rem;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab:hover {
            background: var(--gray-50);
            color: var(--primary-color);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--gray-50);
        }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--gray-500);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--gray-600);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--white);
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background: var(--white);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        /* Status badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #16a34a;
        }

        .badge-warning {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-info {
            background: #e0f2fe;
            color: #0891b2;
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
        }

        /* File upload */
        .file-upload {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--gray-50);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .file-upload.dragover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
                padding: 0 1rem;
            }

            .nav-tab {
                min-width: 120px;
            }

            .main-container {
                padding: 0 1rem 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 3000;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid var(--success-color);
        }

        .toast-error {
            border-left: 4px solid var(--danger-color);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }

        /* Search */
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        /* Action buttons in tables */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span>🏭</span>
                <span>MPSYSTEM Production ERP</span>
            </div>
            <div class="header-actions">
                <div id="storageStatus" class="storage-status connected">
                    💾 Local Storage Active
                </div>
                <button class="btn btn-secondary" onclick="exportData()">
                    📤 Export Data
                </button>
                <button class="btn btn-secondary" onclick="importData()">
                    📥 Import Data
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                📊 Dashboard
            </button>
            <button class="nav-tab" onclick="showTab('materials')">
                📦 Материалы
            </button>
            <button class="nav-tab" onclick="showTab('suppliers')">
                👥 Поставщики
            </button>
            <button class="nav-tab" onclick="showTab('inventory')">
                📋 Остатки
            </button>
            <button class="nav-tab" onclick="showTab('batches')">
                🏷️ Партии
            </button>
            <button class="nav-tab" onclick="showTab('orders')">
                📑 Заказы
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMaterials">0</div>
                    <div class="stat-label">Всего материалов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSuppliers">0</div>
                    <div class="stat-label">Поставщики</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBatches">0</div>
                    <div class="stat-label">Партии</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lowStockCount">0</div>
                    <div class="stat-label">Низкие остатки</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Последние операции</h2>
                </div>
                <div id="recentActivities">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>Операции будут отображаться здесь</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Tab -->
        <div id="materials" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Управление материалами</h2>
                    <button class="btn btn-primary" onclick="showModal('materialModal')">
                        ➕ Добавить материал
                    </button>
                </div>

                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" placeholder="Поиск материалов..." onkeyup="filterMaterials(this.value)">
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>Наименование</th>
                                <th>Тип</th>
                                <th>Единица</th>
                                <th>Стоимость</th>
                                <th>Мин. остаток</th>
                                <th>Поставщик</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTable">
                            <!-- Materials will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="suppliers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Управление поставщиками</h2>
                    <button class="btn btn-primary" onclick="showModal('supplierModal')">
                        ➕ Добавить поставщика
                    </button>
                </div>

                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" placeholder="Поиск поставщиков..." onkeyup="filterSuppliers(this.value)">
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>Наименование</th>
                                <th>Контакт</th>
                                <th>Email</th>
                                <th>Телефон</th>
                                <th>Рейтинг</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTable">
                            <!-- Suppliers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Управление остатками</h2>
                    <button class="btn btn-primary" onclick="showModal('inventoryModal')">
                        ➕ Добавить остаток
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Материал</th>
                                <th>Склад</th>
                                <th>Партия</th>
                                <th>Количество</th>
                                <th>Зарезервировано</th>
                                <th>Доступно</th>
                                <th>Локация</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <!-- Inventory will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Batches Tab -->
        <div id="batches" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Управление партиями</h2>
                    <button class="btn btn-primary" onclick="showModal('batchModal')">
                        ➕ Принять партию
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Номер партии</th>
                                <th>Материал</th>
                                <th>Поставщик</th>
                                <th>Количество</th>
                                <th>Дата получения</th>
                                <th>Статус качества</th>
                                <th>Документы</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="batchesTable">
                            <!-- Batches will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Заказы на производство</h2>
                    <button class="btn btn-primary" onclick="showModal('orderModal')">
                        ➕ Создать заказ
                    </button>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Номер заказа</th>
                                <th>Клиент</th>
                                <th>Продукт</th>
                                <th>Количество</th>
                                <th>Дата заказа</th>
                                <th>Статус</th>
                                <th>Приоритет</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <!-- Orders will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Material Modal -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Добавить материал</h3>
                <button class="modal-close" onclick="hideModal('materialModal')">&times;</button>
            </div>
            <form id="materialForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Код материала</label>
                        <input type="text" name="code" class="form-input" required placeholder="GR-PVD-001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Наименование</label>
                        <input type="text" name="name" class="form-input" required placeholder="Гранулят ПВД прозрачный">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Тип материала</label>
                        <select name="type" class="form-select" required>
                            <option value="">Выберите тип</option>
                            <option value="granulate_ldpe">Гранулят ПВД</option>
                            <option value="granulate_hdpe">Гранулят ПНД</option>
                            <option value="granulate_pp">Гранулят ПП</option>
                            <option value="ink_printing">Краска для печати</option>
                            <option value="adhesive_pu">Клей ПУ</option>
                            <option value="adhesive_acrylic">Клей акриловый</option>
                            <option value="solvent">Растворитель</option>
                            <option value="additive">Добавка</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Единица измерения</label>
                        <select name="unit" class="form-select" required>
                            <option value="">Выберите единицу</option>
                            <option value="кг">кг</option>
                            <option value="л">л</option>
                            <option value="м">м</option>
                            <option value="шт">шт</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Стандартная стоимость</label>
                        <input type="number" name="standard_cost" class="form-input" step="0.01" placeholder="245.50">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Минимальный остаток</label>
                        <input type="number" name="min_stock_level" class="form-input" step="0.01" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Точка перезаказа</label>
                        <input type="number" name="reorder_point" class="form-input" step="0.01" placeholder="2000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Поставщик</label>
                        <select name="supplier_id" class="form-select" id="materialSupplierSelect">
                            <option value="">Выберите поставщика</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea name="description" class="form-textarea" placeholder="Описание материала"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">💾 Сохранить</button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal('materialModal')">❌ Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Добавить поставщика</h3>
                <button class="modal-close" onclick="hideModal('supplierModal')">&times;</button>
            </div>
            <form id="supplierForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Код поставщика</label>
                        <input type="text" name="code" class="form-input" required placeholder="SUP001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Наименование</label>
                        <input type="text" name="name" class="form-input" required placeholder="Dow Chemical Europe">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Контактное лицо</label>
                        <input type="text" name="contact_person" class="form-input" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-input" placeholder="contact@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Телефон</label>
                        <input type="tel" name="phone" class="form-input" placeholder="+7-495-123-4567">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Статус</label>
                        <select name="is_active" class="form-select">
                            <option value="true">Активный</option>
                            <option value="false">Неактивный</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Адрес</label>
                    <textarea name="address" class="form-textarea" placeholder="Адрес поставщика"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">💾 Сохранить</button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal('supplierModal')">❌ Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Additional modals for inventory, batches, orders would follow similar pattern -->

                <!-- Inventory Modal -->
            <div id="inventoryModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Добавить остаток</h3>
                        <button class="modal-close" onclick="hideModal('inventoryModal')">&times;</button>
                    </div>
                    <form id="inventoryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Материал</label>
                                <select name="material_id" class="form-select" required id="inventoryMaterialSelect">
                                    <option value="">Выберите материал</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Склад</label>
                                <select name="warehouse" class="form-select" required>
                                    <option value="">Выберите склад</option>
                                    <option value="MAG-1">MAG-1 - Основной склад</option>
                                    <option value="MAG-2">MAG-2 - Склад готовой продукции</option>
                                    <option value="MAG-3">MAG-3 - Склад брака</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Номер партии</label>
                                <input type="text" name="batch_number" class="form-input" placeholder="240115-001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Количество</label>
                                <input type="number" name="quantity" class="form-input" step="0.01" required placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Зарезервировано</label>
                                <input type="number" name="reserved_quantity" class="form-input" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Локация</label>
                                <input type="text" name="location_code" class="form-input" placeholder="A1-05-02">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">💾 Сохранить</button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal('inventoryModal')">❌ Отмена</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Batch Modal -->
            <div id="batchModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Принять партию</h3>
                        <button class="modal-close" onclick="hideModal('batchModal')">&times;</button>
                    </div>
                    <form id="batchForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Номер партии</label>
                                <input type="text" name="batch_number" class="form-input" required placeholder="240115-001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Материал</label>
                                <select name="material_id" class="form-select" required id="batchMaterialSelect">
                                    <option value="">Выберите материал</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Поставщик</label>
                                <select name="supplier_id" class="form-select" required id="batchSupplierSelect">
                                    <option value="">Выберите поставщика</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Получено количество</label>
                                <input type="number" name="received_quantity" class="form-input" step="0.01" required placeholder="2500">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Дата производства</label>
                                <input type="date" name="production_date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Дата получения</label>
                                <input type="date" name="received_date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Статус качества</label>
                                <select name="quality_status" class="form-select" required>
                                    <option value="pending">Ожидает контроля</option>
                                    <option value="approved">Одобрено</option>
                                    <option value="quarantine">Карантин</option>
                                    <option value="blocked">Заблокировано</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <h4>Документы:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="has_coa" value="true"> Сертификат анализа (CoA)
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="has_tds" value="true"> Техническая спецификация (TDS)
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="has_sds" value="true"> Паспорт безопасности (SDS)
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="has_doc" value="true"> Декларация соответствия (DoC)
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="has_cmr" value="true"> Транспортная накладная (CMR)
                                </label>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">💾 Принять партию</button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal('batchModal')">❌ Отмена</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Modal -->
            <div id="orderModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Создать заказ</h3>
                        <button class="modal-close" onclick="hideModal('orderModal')">&times;</button>
                    </div>
                    <form id="orderForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Номер заказа</label>
                                <input type="text" name="order_number" class="form-input" required placeholder="ORD-240001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Клиент</label>
                                <input type="text" name="customer" class="form-input" required placeholder="ООО Пищепром">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Продукт</label>
                                <input type="text" name="product" class="form-input" required placeholder="Пленка ПЭТ 12мкм">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Количество</label>
                                <input type="number" name="quantity" class="form-input" step="0.01" required placeholder="5000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Дата заказа</label>
                                <input type="date" name="order_date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Дата поставки</label>
                                <input type="date" name="delivery_date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Статус</label>
                                <select name="status" class="form-select" required>
                                    <option value="new">Новый</option>
                                    <option value="planned">Запланирован</option>
                                    <option value="in_production">В производстве</option>
                                    <option value="completed">Завершен</option>
                                    <option value="shipped">Отгружен</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Приоритет</label>
                                <select name="priority" class="form-select" required>
                                    <option value="low">Низкий</option>
                                    <option value="medium">Средний</option>
                                    <option value="high">Высокий</option>
                                    <option value="critical">Критический</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Комментарии</label>
                            <textarea name="notes" class="form-textarea" placeholder="Дополнительные требования к заказу"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">💾 Создать заказ</button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal('orderModal')">❌ Отмена</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- File input for import -->
            <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="handleFileImport(event)">

    <script>
        // =============================================
        // DATA STORAGE AND MANAGEMENT
        // =============================================
        
        class ERPStorage {
            constructor() {
                this.storageKey = 'mpsystem_erp_data';
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.storageKey)) {
                    this.initializeWithSampleData();
                }
                this.updateStorageStatus();
            }

            initializeWithSampleData() {
                const sampleData = {
                    materials: [
                        {
                            id: 1,
                            code: 'GR-PVD-001',
                            name: 'Гранулят ПВД LDPE 020C прозрачный',
                            type: 'granulate_ldpe',
                            unit: 'кг',
                            description: 'Гранулят полиэтилена низкого давления для производства прозрачной пленки',
                            standard_cost: 245.50,
                            min_stock_level: 1000.0,
                            reorder_point: 2000.0,
                            supplier_id: 1,
                            is_active: true,
                            created_at: new Date().toISOString()
                        },
                        {
                            id: 2,
                            code: 'INK-RED-001',
                            name: 'Краска красная RAL 3020',
                            type: 'ink_printing',
                            unit: 'кг',
                            description: 'Краска для флексографической печати, красный цвет RAL 3020',
                            standard_cost: 1250.00,
                            min_stock_level: 50.0,
                            reorder_point: 100.0,
                            supplier_id: 2,
                            is_active: true,
                            created_at: new Date().toISOString()
                        }
                    ],
                    suppliers: [
                        {
                            id: 1,
                            code: 'SUP001',
                            name: 'Dow Chemical Europe',
                            contact_person: 'John Smith',
                            email: 'john.smith@dow.com',
                            phone: '+49-123-456789',
                            address: 'Industrial Park, Germany',
                            rating_delivery: 98.5,
                            rating_quality: 99.2,
                            rating_documents: 100.0,
                            rating_cooperation: 85.0,
                            overall_rating: 95.8,
                            is_active: true,
                            is_approved: true,
                            created_at: new Date().toISOString()
                        },
                        {
                            id: 2,
                            code: 'SUP002',
                            name: 'Siegwerk Druckfarben',
                            contact_person: 'Klaus Mueller',
                            email: 'k.mueller@siegwerk.com',
                            phone: '+49-2241-304-0',
                            address: 'Siegburg, Germany',
                            rating_delivery: 92.8,
                            rating_quality: 98.5,
                            rating_documents: 96.0,
                            rating_cooperation: 90.0,
                            overall_rating: 94.5,
                            is_active: true,
                            is_approved: true,
                            created_at: new Date().toISOString()
                        }
                    ],
                    inventory: [
                        {
                            id: 1,
                            material_id: 1,
                            warehouse: 'MAG-1',
                            batch_number: '240115-001',
                            quantity: 2500.0,
                            reserved_quantity: 0.0,
                            available_quantity: 2500.0,
                            location_code: 'A1-05-02',
                            last_movement_date: new Date().toISOString()
                        }
                    ],
                    batches: [
                        {
                            id: 1,
                            batch_number: '240115-001',
                            material_id: 1,
                            supplier_id: 1,
                            received_quantity: 2500.0,
                            available_quantity: 2500.0,
                            production_date: '2024-01-10',
                            received_date: '2024-01-15',
                            quality_status: 'approved',
                            has_coa: true,
                            has_tds: true,
                            has_sds: true,
                            has_doc: true,
                            has_cmr: true,
                            created_at: new Date().toISOString()
                        }
                    ],
                    orders: [],
                    activities: [
                        {
                            id: 1,
                            type: 'material_created',
                            description: 'Создан материал GR-PVD-001',
                            timestamp: new Date().toISOString()
                        }
                    ]
                };

                this.setData(sampleData);
                this.addActivity('system_init', 'Система инициализирована с образцовыми данными');
            }

            getData() {
                try {
                    return JSON.parse(localStorage.getItem(this.storageKey)) || {};
                } catch (e) {
                    console.error('Error parsing storage data:', e);
                    return {};
                }
            }

            setData(data) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                    this.updateStorageStatus();
                    return true;
                } catch (e) {
                    console.error('Error saving to storage:', e);
                    showToast('Ошибка сохранения данных', 'error');
                    return false;
                }
            }

            getTable(tableName) {
                const data = this.getData();
                return data[tableName] || [];
            }

            setTable(tableName, tableData) {
                const data = this.getData();
                data[tableName] = tableData;
                return this.setData(data);
            }

            addRecord(tableName, record) {
                const table = this.getTable(tableName);
                const newId = table.length > 0 ? Math.max(...table.map(r => r.id)) + 1 : 1;
                const newRecord = {
                    id: newId,
                    ...record,
                    created_at: new Date().toISOString()
                };
                table.push(newRecord);
                this.setTable(tableName, table);
                return newRecord;
            }

            updateRecord(tableName, id, updates) {
                const table = this.getTable(tableName);
                const index = table.findIndex(r => r.id === id);
                if (index !== -1) {
                    table[index] = { ...table[index], ...updates, updated_at: new Date().toISOString() };
                    this.setTable(tableName, table);
                    return table[index];
                }
                return null;
            }

            deleteRecord(tableName, id) {
                const table = this.getTable(tableName);
                const filteredTable = table.filter(r => r.id !== id);
                this.setTable(tableName, filteredTable);
                return true;
            }

            addActivity(type, description) {
                const activities = this.getTable('activities');
                const newActivity = {
                    id: activities.length + 1,
                    type,
                    description,
                    timestamp: new Date().toISOString()
                };
                activities.unshift(newActivity); // Add to beginning
                activities.splice(10); // Keep only last 10
                this.setTable('activities', activities);
            }

            updateStorageStatus() {
                const data = this.getData();
                const size = new Blob([JSON.stringify(data)]).size;
                const statusElement = document.getElementById('storageStatus');
                if (statusElement) {
                    statusElement.textContent = `💾 Local Storage (${(size / 1024).toFixed(1)} KB)`;
                }
            }

            exportData() {
                const data = this.getData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mpsystem_erp_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Данные экспортированы', 'success');
            }

            importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    this.setData(data);
                    this.addActivity('data_import', 'Данные импортированы из файла');
                    showToast('Данные успешно импортированы', 'success');
                    refreshCurrentTab();
                    return true;
                } catch (e) {
                    console.error('Import error:', e);
                    showToast('Ошибка импорта данных', 'error');
                    return false;
                }
            }
        }

        // Initialize storage
        const storage = new ERPStorage();

        // =============================================
        // UI MANAGEMENT
        // =============================================

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load tab content
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'materials':
                    loadMaterials();
                    break;
                case 'suppliers':
                    loadSuppliers();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'batches':
                    loadBatches();
                    break;
                case 'orders':
                    loadOrders();
                    break;
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');

            // Load data for specific modals
            if (modalId === 'materialModal') {
                loadSuppliersSelect();
            } else if (modalId === 'inventoryModal') {
                loadMaterialsSelect('inventoryMaterialSelect');
            } else if (modalId === 'batchModal') {
                loadMaterialsSelect('batchMaterialSelect');
                loadSuppliersSelect('batchSupplierSelect');
            }
        }

        function loadMaterialsSelect(selectId) {
            const materials = storage.getTable('materials');
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Выберите материал</option>' + 
                materials.map(m => `<option value="${m.id}">${m.code} - ${m.name}</option>`).join('');
        }

        function loadSuppliersSelect(selectId = 'materialSupplierSelect') {
            const suppliers = storage.getTable('suppliers');
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Выберите поставщика</option>' + 
                suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            
            // Reset form and edit state
            const form = modal.querySelector('form');
            if (form) {
                form.reset();
                delete form.dataset.editId;
            }
            
            // Reset modal titles
            if (modalId === 'materialModal') {
                document.querySelector('#materialModal h3').textContent = 'Добавить материал';
            } else if (modalId === 'supplierModal') {
                document.querySelector('#supplierModal h3').textContent = 'Добавить поставщика';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // =============================================
        // DASHBOARD FUNCTIONS
        // =============================================

        function loadDashboard() {
            const materials = storage.getTable('materials');
            const suppliers = storage.getTable('suppliers');
            const batches = storage.getTable('batches');
            const inventory = storage.getTable('inventory');
            const activities = storage.getTable('activities');

            // Update stats
            document.getElementById('totalMaterials').textContent = materials.length;
            document.getElementById('totalSuppliers').textContent = suppliers.length;
            document.getElementById('totalBatches').textContent = batches.length;
            
            // Calculate low stock count
            const lowStockCount = materials.filter(m => {
                const inventoryItem = inventory.find(i => i.material_id === m.id);
                return inventoryItem && m.min_stock_level && inventoryItem.available_quantity < m.min_stock_level;
            }).length;
            document.getElementById('lowStockCount').textContent = lowStockCount;

            // Load recent activities
            const activitiesHtml = activities.length > 0 ? activities.map(activity => `
                <div style="padding: 1rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between;">
                    <span>${activity.description}</span>
                    <span style="color: var(--gray-500); font-size: 0.875rem;">${new Date(activity.timestamp).toLocaleString()}</span>
                </div>
            `).join('') : `
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <p>Операции будут отображаться здесь</p>
                </div>
            `;

            document.getElementById('recentActivities').innerHTML = activitiesHtml;
        }

        // =============================================
        // MATERIALS FUNCTIONS
        // =============================================

        function loadMaterials() {
            const materials = storage.getTable('materials');
            const suppliers = storage.getTable('suppliers');
            
            const materialsHtml = materials.map(material => {
                const supplier = suppliers.find(s => s.id === material.supplier_id);
                return `
                    <tr>
                        <td><strong>${material.code}</strong></td>
                        <td>${material.name}</td>
                        <td><span class="badge badge-info">${getTypeLabel(material.type)}</span></td>
                        <td>${material.unit}</td>
                        <td>${material.standard_cost ? material.standard_cost.toFixed(2) + ' ₽' : '-'}</td>
                        <td>${material.min_stock_level || '-'}</td>
                        <td>${supplier ? supplier.name : '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="editMaterial(${material.id})">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMaterial(${material.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('materialsTable').innerHTML = materialsHtml || `
                <tr><td colspan="8" class="empty-state">Материалы не найдены</td></tr>
            `;
        }

        function filterMaterials(searchTerm) {
            const materials = storage.getTable('materials');
            const suppliers = storage.getTable('suppliers');
            const filtered = materials.filter(m => 
                m.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                m.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const materialsHtml = filtered.map(material => {
                const supplier = suppliers.find(s => s.id === material.supplier_id);
                return `
                    <tr>
                        <td><strong>${material.code}</strong></td>
                        <td>${material.name}</td>
                        <td><span class="badge badge-info">${getTypeLabel(material.type)}</span></td>
                        <td>${material.unit}</td>
                        <td>${material.standard_cost ? material.standard_cost.toFixed(2) + ' ₽' : '-'}</td>
                        <td>${material.min_stock_level || '-'}</td>
                        <td>${supplier ? supplier.name : '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="editMaterial(${material.id})">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMaterial(${material.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('materialsTable').innerHTML = materialsHtml || `
                <tr><td colspan="8" class="empty-state">Материалы не найдены</td></tr>
            `;
        }

        function getTypeLabel(type) {
            const types = {
                'granulate_ldpe': 'Гранулят ПВД',
                'granulate_hdpe': 'Гранулят ПНД',
                'granulate_pp': 'Гранулят ПП',
                'ink_printing': 'Краска',
                'adhesive_pu': 'Клей ПУ',
                'adhesive_acrylic': 'Клей акриловый',
                'solvent': 'Растворитель',
                'additive': 'Добавка'
            };
            return types[type] || type;
        }



        function deleteMaterial(id) {
            if (confirm('Вы уверены, что хотите удалить этот материал?')) {
                const material = storage.getTable('materials').find(m => m.id === id);
                storage.deleteRecord('materials', id);
                storage.addActivity('material_deleted', `Удален материал ${material.code}`);
                showToast('Материал удален', 'success');
                loadMaterials();
                loadDashboard(); // Update stats
            }
        }

        // =============================================
        // SUPPLIERS FUNCTIONS  
        // =============================================

        function loadSuppliers() {
            const suppliers = storage.getTable('suppliers');
            
            const suppliersHtml = suppliers.map(supplier => `
                <tr>
                    <td><strong>${supplier.code}</strong></td>
                    <td>${supplier.name}</td>
                    <td>${supplier.contact_person || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.overall_rating ? supplier.overall_rating.toFixed(1) + '/100' : '-'}</td>
                    <td>
                        <span class="badge ${supplier.is_active ? 'badge-success' : 'badge-danger'}">
                            ${supplier.is_active ? 'Активный' : 'Неактивный'}
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="editSupplier(${supplier.id})">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${supplier.id})">🗑️</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('suppliersTable').innerHTML = suppliersHtml || `
                <tr><td colspan="8" class="empty-state">Поставщики не найдены</td></tr>
            `;
        }

        function filterSuppliers(searchTerm) {
            const suppliers = storage.getTable('suppliers');
            const filtered = suppliers.filter(s => 
                s.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                s.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const suppliersHtml = filtered.map(supplier => `
                <tr>
                    <td><strong>${supplier.code}</strong></td>
                    <td>${supplier.name}</td>
                    <td>${supplier.contact_person || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.overall_rating ? supplier.overall_rating.toFixed(1) + '/100' : '-'}</td>
                    <td>
                        <span class="badge ${supplier.is_active ? 'badge-success' : 'badge-danger'}">
                            ${supplier.is_active ? 'Активный' : 'Неактивный'}
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="editSupplier(${supplier.id})">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${supplier.id})">🗑️</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('suppliersTable').innerHTML = suppliersHtml || `
                <tr><td colspan="8" class="empty-state">Поставщики не найдены</td></tr>
            `;
        }

        function deleteSupplier(id) {
            if (confirm('Вы уверены, что хотите удалить этого поставщика?')) {
                const supplier = storage.getTable('suppliers').find(s => s.id === id);
                storage.deleteRecord('suppliers', id);
                storage.addActivity('supplier_deleted', `Удален поставщик ${supplier.name}`);
                showToast('Поставщик удален', 'success');
                loadSuppliers();
                loadDashboard(); // Update stats
            }
        }

        // =============================================
        // INVENTORY FUNCTIONS
        // =============================================

        function loadInventory() {
            const inventory = storage.getTable('inventory');
            const materials = storage.getTable('materials');
            
            const inventoryHtml = inventory.map(item => {
                const material = materials.find(m => m.id === item.material_id);
                return `
                    <tr>
                        <td>${material ? material.name : 'Unknown'}</td>
                        <td>${item.warehouse}</td>
                        <td>${item.batch_number || '-'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.reserved_quantity}</td>
                        <td>${item.available_quantity}</td>
                        <td>${item.location_code || '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="editInventory(${item.id})">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInventory(${item.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('inventoryTable').innerHTML = inventoryHtml || `
                <tr><td colspan="8" class="empty-state">Остатки не найдены</td></tr>
            `;
        }

        // =============================================
        // BATCHES FUNCTIONS
        // =============================================

        function loadBatches() {
            const batches = storage.getTable('batches');
            const materials = storage.getTable('materials');
            const suppliers = storage.getTable('suppliers');
            
            const batchesHtml = batches.map(batch => {
                const material = materials.find(m => m.id === batch.material_id);
                const supplier = suppliers.find(s => s.id === batch.supplier_id);
                const documents = [
                    batch.has_coa ? 'CoA' : null,
                    batch.has_tds ? 'TDS' : null,
                    batch.has_sds ? 'SDS' : null,
                    batch.has_doc ? 'DoC' : null,
                    batch.has_cmr ? 'CMR' : null
                ].filter(Boolean).join(', ');

                return `
                    <tr>
                        <td><strong>${batch.batch_number}</strong></td>
                        <td>${material ? material.name : 'Unknown'}</td>
                        <td>${supplier ? supplier.name : 'Unknown'}</td>
                        <td>${batch.received_quantity}</td>
                        <td>${new Date(batch.received_date).toLocaleDateString()}</td>
                        <td>
                            <span class="badge ${getQualityStatusClass(batch.quality_status)}">
                                ${getQualityStatusLabel(batch.quality_status)}
                            </span>
                        </td>
                        <td><small>${documents || 'Нет'}</small></td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="editBatch(${batch.id})">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBatch(${batch.id})">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('batchesTable').innerHTML = batchesHtml || `
                <tr><td colspan="8" class="empty-state">Партии не найдены</td></tr>
            `;
        }

        function getQualityStatusClass(status) {
            const classes = {
                'pending': 'badge-warning',
                'approved': 'badge-success',
                'blocked': 'badge-danger',
                'quarantine': 'badge-warning'
            };
            return classes[status] || 'badge-info';
        }

        function getQualityStatusLabel(status) {
            const labels = {
                'pending': 'Ожидает',
                'approved': 'Одобрено',
                'blocked': 'Заблокировано',
                'quarantine': 'Карантин'
            };
            return labels[status] || status;
        }

        // =============================================
        // ORDERS FUNCTIONS
        // =============================================

        function loadOrders() {
            const orders = storage.getTable('orders');
            
            const ordersHtml = orders.length ? orders.map(order => `
                <tr>
                    <td><strong>${order.order_number}</strong></td>
                    <td>${order.customer}</td>
                    <td>${order.product}</td>
                    <td>${order.quantity}</td>
                    <td>${new Date(order.order_date).toLocaleDateString()}</td>
                    <td>
                        <span class="badge ${getOrderStatusClass(order.status)}">
                            ${getOrderStatusLabel(order.status)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${getPriorityClass(order.priority)}">
                            ${getPriorityLabel(order.priority)}
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning" onclick="editOrder(${order.id})">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})">🗑️</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="8" class="empty-state">Заказы не найдены</td></tr>`;

            document.getElementById('ordersTable').innerHTML = ordersHtml;
        }

        function getOrderStatusClass(status) {
            const classes = {
                'new': 'badge-info',
                'planned': 'badge-warning',
                'in_production': 'badge-warning',
                'completed': 'badge-success',
                'shipped': 'badge-success',
                'cancelled': 'badge-danger'
            };
            return classes[status] || 'badge-info';
        }

        function getOrderStatusLabel(status) {
            const labels = {
                'new': 'Новый',
                'planned': 'Запланирован',
                'in_production': 'В производстве',
                'completed': 'Завершен',
                'shipped': 'Отгружен',
                'cancelled': 'Отменен'
            };
            return labels[status] || status;
        }

        function getPriorityClass(priority) {
            const classes = {
                'low': 'badge-info',
                'medium': 'badge-warning',
                'high': 'badge-danger',
                'critical': 'badge-danger'
            };
            return classes[priority] || 'badge-info';
        }

        function getPriorityLabel(priority) {
            const labels = {
                'low': 'Низкий',
                'medium': 'Средний',
                'high': 'Высокий',
                'critical': 'Критический'
            };
            return labels[priority] || priority;
        }

        // =============================================
        // FORM HANDLERS
        // =============================================

        // Material form handler
        document.getElementById('materialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const materialData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    if (['standard_cost', 'min_stock_level', 'reorder_point'].includes(key)) {
                        materialData[key] = parseFloat(value);
                    } else if (key === 'supplier_id') {
                        materialData[key] = parseInt(value);
                    } else {
                        materialData[key] = value;
                    }
                }
            }

            const editId = this.dataset.editId;
            if (editId) {
                // Update existing material
                const updated = storage.updateRecord('materials', parseInt(editId), materialData);
                storage.addActivity('material_updated', `Обновлен материал ${updated.code}`);
                showToast('Материал обновлен', 'success');
                delete this.dataset.editId;
                document.querySelector('#materialModal h3').textContent = 'Добавить материал';
            } else {
                // Create new material
                const newMaterial = storage.addRecord('materials', materialData);
                storage.addActivity('material_created', `Создан материал ${newMaterial.code}`);
                showToast('Материал создан', 'success');
            }
            
            hideModal('materialModal');
            loadMaterials();
            loadDashboard();
        });

        // Supplier form handler
        document.getElementById('supplierForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const supplierData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    if (key === 'is_active') {
                        supplierData[key] = value === 'true';
                    } else {
                        supplierData[key] = value;
                    }
                }
            }

            const editId = this.dataset.editId;
            if (editId) {
                // Update existing supplier
                const updated = storage.updateRecord('suppliers', parseInt(editId), supplierData);
                storage.addActivity('supplier_updated', `Обновлен поставщик ${updated.name}`);
                showToast('Поставщик обновлен', 'success');
                delete this.dataset.editId;
                document.querySelector('#supplierModal h3').textContent = 'Добавить поставщика';
            } else {
                // Create new supplier
                const newSupplier = storage.addRecord('suppliers', supplierData);
                storage.addActivity('supplier_created', `Создан поставщик ${newSupplier.name}`);
                showToast('Поставщик создан', 'success');
            }
            
            hideModal('supplierModal');
            loadSuppliers();
            loadDashboard();
        });

        // Inventory form handler
        document.getElementById('inventoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const inventoryData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    if (['material_id'].includes(key)) {
                        inventoryData[key] = parseInt(value);
                    } else if (['quantity', 'reserved_quantity'].includes(key)) {
                        inventoryData[key] = parseFloat(value);
                    } else {
                        inventoryData[key] = value;
                    }
                }
            }

            // Calculate available quantity
            inventoryData.available_quantity = inventoryData.quantity - (inventoryData.reserved_quantity || 0);
            inventoryData.last_movement_date = new Date().toISOString();

            const newInventory = storage.addRecord('inventory', inventoryData);
            storage.addActivity('inventory_added', `Добавлен остаток для материала`);
            showToast('Остаток добавлен', 'success');
            hideModal('inventoryModal');
            loadInventory();
            loadDashboard();
        });

        // Batch form handler
        document.getElementById('batchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const batchData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    if (['material_id', 'supplier_id'].includes(key)) {
                        batchData[key] = parseInt(value);
                    } else if (['received_quantity'].includes(key)) {
                        batchData[key] = parseFloat(value);
                    } else if (key.startsWith('has_')) {
                        batchData[key] = true; // checkbox checked
                    } else {
                        batchData[key] = value;
                    }
                }
            }

            // Set available quantity equal to received quantity initially
            batchData.available_quantity = batchData.received_quantity;

            const newBatch = storage.addRecord('batches', batchData);
            storage.addActivity('batch_received', `Принята партия ${newBatch.batch_number}`);
            showToast('Партия принята', 'success');
            hideModal('batchModal');
            loadBatches();
            loadDashboard();
        });

        // Order form handler
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const orderData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value) {
                    if (['quantity'].includes(key)) {
                        orderData[key] = parseFloat(value);
                    } else {
                        orderData[key] = value;
                    }
                }
            }

            const newOrder = storage.addRecord('orders', orderData);
            storage.addActivity('order_created', `Создан заказ ${newOrder.order_number}`);
            showToast('Заказ создан', 'success');
            hideModal('orderModal');
            loadOrders();
            loadDashboard();
        });

        // =============================================
        // EXPORT/IMPORT FUNCTIONS
        // =============================================

        function exportData() {
            storage.exportData();
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    storage.importData(e.target.result);
                };
                reader.readAsText(file);
            }
        }

        function refreshCurrentTab() {
            const activeTab = document.querySelector('.nav-tab.active');
            if (activeTab) {
                activeTab.click();
            }
        }

        // =============================================
        // INITIALIZATION
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            
            // Add click outside modal to close
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
        });

        // Delete functions for other entities
        function deleteInventory(id) {
            if (confirm('Вы уверены, что хотите удалить этот остаток?')) {
                storage.deleteRecord('inventory', id);
                storage.addActivity('inventory_deleted', 'Удален остаток');
                showToast('Остаток удален', 'success');
                loadInventory();
                loadDashboard();
            }
        }

        function deleteBatch(id) {
            if (confirm('Вы уверены, что хотите удалить эту партию?')) {
                const batch = storage.getTable('batches').find(b => b.id === id);
                storage.deleteRecord('batches', id);
                storage.addActivity('batch_deleted', `Удалена партия ${batch.batch_number}`);
                showToast('Партия удалена', 'success');
                loadBatches();
                loadDashboard();
            }
        }

        function deleteOrder(id) {
            if (confirm('Вы уверены, что хотите удалить этот заказ?')) {
                const order = storage.getTable('orders').find(o => o.id === id);
                storage.deleteRecord('orders', id);
                storage.addActivity('order_deleted', `Удален заказ ${order.order_number}`);
                showToast('Заказ удален', 'success');
                loadOrders();
                loadDashboard();
            }
        }

        // Edit functions (simplified - open modal with data)
        function editMaterial(id) {
            const material = storage.getTable('materials').find(m => m.id === id);
            if (material) {
                // Fill form with existing data
                const form = document.getElementById('materialForm');
                Object.keys(material).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = material[key];
                    }
                });
                
                // Change form behavior to update instead of create
                form.dataset.editId = id;
                document.querySelector('#materialModal h3').textContent = 'Редактировать материал';
                showModal('materialModal');
            }
        }

        function editSupplier(id) {
            const supplier = storage.getTable('suppliers').find(s => s.id === id);
            if (supplier) {
                const form = document.getElementById('supplierForm');
                Object.keys(supplier).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = supplier[key];
                        } else {
                            input.value = supplier[key];
                        }
                    }
                });
                
                form.dataset.editId = id;
                document.querySelector('#supplierModal h3').textContent = 'Редактировать поставщика';
                showModal('supplierModal');
            }
        }

        function editInventory(id) {
            showToast('Редактирование остатков - в разработке', 'warning');
        }

        function editBatch(id) {
            showToast('Редактирование партии - в разработке', 'warning');
        }

        function editOrder(id) {
            showToast('Редактирование заказа - в разработке', 'warning');
        }
    </script>
</body>
</html>